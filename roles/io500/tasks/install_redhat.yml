---
# redhat OS family tasks for io500

- name: install_redhat | Install the 'Development tools' group
  ansible.builtin.package:
    name: "@Development tools"
    state: present

- name: install_redhat | Install dependecies
  ansible.builtin.package:
    name: "{{ io500_dep_pkgs }}"
    state: present

- name: install_redhat | Install daos-devel
  ansible.builtin.package:
    name: "daos-devel"
    state: present

- name: install_redhat | Clone IO500 repo
  ansible.builtin.git:
    repo: https://github.com/IO500/io500.git
    dest: "{{ io500_install_dir }}"
    version: "{{ io500_version }}"
    force: true

# - name: install_redhat | Set permissions on IO500 directories
#   ansible.builtin.find:
#     paths: "{{ io500_install_dir }}"
#     recurse: yes
#     file_type: directory
#   register: io500_directories

# - name: install_redhat | Set directory permissions to 0755
#   ansible.builtin.file:
#     path: "{{ item.path }}"
#     mode: '0755'
#   loop: "{{ io500_directories.files }}"

- name: install_redhat | Run prepare.sh script
  ansible.builtin.shell: |
    export I_MPI_OFI_LIBRARY_INTERNAL=0
    export I_MPI_OFI_PROVIDER="tcp;ofi_rxm"
    source /opt/intel/oneapi/setvars.sh
    "{{ io500_install_dir }}/prepare.sh"
  args:
    chdir: "{{ io500_install_dir }}"
    executable: /bin/bash
    creates: "{{ io500_install_dir }}/io500.sh"

# - name: install_redhat | Create io500_ini directory
#   ansible.builtin.file:
#     path: "{{ io500_script_dir }}/io500_ini"
#     state: directory
#     owner: "{{ io500_user }}"
#     group: "{{ io500_user }}"
#     mode: '0755'

- name: install_redhat | Copy io500 ini files
  ansible.builtin.copy:
    src: "io500_ini"
    dest: "{{ io500_script_dir }}"
    owner: "{{ io500_user }}"
    group: "{{ io500_user }}"
    mode: '0644'

- name: Copy run_io500.sh script
  ansible.builtin.copy:
    src: run_io500.sh
    dest: "{{ io500_script_dir }}/run_io500.sh"
    owner: "{{ io500_user }}"
    group: "{{ io500_user }}"
    mode: '0755'
