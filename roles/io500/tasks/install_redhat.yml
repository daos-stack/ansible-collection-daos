---
# redhat OS family tasks for io500

- name: install_redhat | Install the 'Development tools' group
  ansible.builtin.package:
    name: "@Development tools"
    state: present

- name: install_redhat | Install dependecies
  ansible.builtin.package:
    name: "{{ io500_dep_pkgs }}"
    state: present

- name: install_redhat | Install daos-devel
  ansible.builtin.package:
    name: "daos-devel"
    state: present

- name: Clone IO500 repo
  ansible.builtin.git:
    repo: https://github.com/IO500/io500.git
    dest: "{{ io500_path }}"
    version: "{{ io500_version }}"
    force: true

- name: Set permissions on IO500 directories
  ansible.builtin.find:
    paths: "{{ io500_path }}"
    recurse: yes
    file_type: directory
  register: io500_directories

- name: Set directory permissions to 0755
  ansible.builtin.file:
    path: "{{ item.path }}"
    mode: '0755'
  loop: "{{ io500_directories.files }}"

- name: Run prepare.sh script
  ansible.builtin.shell: |
    export I_MPI_OFI_LIBRARY_INTERNAL=0
    export I_MPI_OFI_PROVIDER="tcp;ofi_rxm"
    source /opt/intel/oneapi/setvars.sh
    "{{ io500_path }}/prepare.sh"
  args:
    chdir: "{{ io500_path }}"
    executable: /bin/bash

- name: Copy run_io500.sh script
  ansible.builtin.template:
    src: run_io500.sh.j2
    dest: "{{ io500_run_io500_path }}"
    owner: "{{ io500_admin_username }}"
    group: "{{ io500_admin_username }}"
    mode: '0755'

- name: Create io500_ini directory
  ansible.builtin.file:
    path: "{{ io500_run_io500_path | dirname }}/io500_ini"
    state: directory
    owner: "{{ io500_admin_username }}"
    group: "{{ io500_admin_username }}"
    mode: '0755'

- name: Copy io500 ini files
  ansible.builtin.copy:
    src: "io500_ini"
    dest: "{{ io500_run_io500_path | dirname }}"
    owner: "{{ io500_admin_username }}"
    group: "{{ io500_admin_username }}"
    mode: '0644'
